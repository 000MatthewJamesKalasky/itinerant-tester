# https://github.com/actions/setup-python/blob/main/docs/advanced-usage.md#using-the-python-version-file-input
# https://raw.githubusercontent.com/actions/python-versions/main/versions-manifest.json
name: python_version_file
on: [pull_request, push]
jobs:
  example_job:
    runs-on: ubuntu-latest
    steps:
      - name: set_env
        run: |
          python -c "import os; os.environ['test_value'] = '7'"
      # - run: echo ${{ set_env.env.test_value }}
      - name: Test environment variable
        run: echo $test_value
  example_job_2:
    runs-on: ubuntu-latest
    steps:
      - run: echo {{ GITHUB_ENV }}
      - name: set_env_2
        shell: python
        run: |
          import os
          os.environ["GITHUB_ENV"] += "\ntest_value=7"
      - run: echo ${{ GITHUB_ENV }}
      # - run: echo ${{ set_env_2.env.test_value }}
      - name: Test environment variable
        run: echo $test_value
  python_version_file:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Read the Python version from Makefile.envs
        shell: python
        run: |
          from pathlib import Path
          lines = Path("Makefile.envs").read_text().splitlines()
          # Looking for a line like: "export PYVERSION ?= 3.11.1"
          python_version = next(
              (line.split()[3] for line in lines if line.startswith("export PYVERSION ?= ")),
              "PYVERSION not found!"
          )
          # Write an ephemeral file because GitHub Actions do not git commit changes
          Path("python-version").write_text(python_version)
      - uses: actions/setup-python@v4
        with:
          python-version-file: "python-version"  # Use the ephemeral file generated above
      - shell: python
        run: import sys ; print(sys.version)
  other:
    runs-on: ubuntu-latest
    needs: python_version_file
    steps:
      - shell: python
        run: import sys ; print(sys.version)
