name: black_force_exclude_on_demand
on:
  workflow_dispatch:
    inputs:
      repo:
        description: 'Repo to test (user_name/repo_name)'
        required: true

jobs:
  black_force_exclude_on_demand:
    runs-on: ubuntu-latest
    steps:
      - run: echo "Testing ${{ github.event.inputs.repo }}..."
      - uses: actions/checkout@v3
        with:
          repository: ${{ github.event.inputs.repo }}
      - uses: actions/setup-python@v4
        with:
          python-version: "3.x"
      - run: pip install black tomli
      - run: mv pyproject.toml pyproject.toml.disabled
      - run: shopt -s globstar && black --check **/*.py | tee black.out.txt || true
      - run: mv pyproject.toml.disabled pyproject.toml
      - shell: python
        run: |
          from pathlib import Path
          import tomli
          data = tomli.loads(Path("pyproject.toml").read_test())
          force_exclude = data['tool']['black']['force-exclude'].splitlines()
          expected = {line.strip("|^ /") for line in force_exclude if "/" in line}
          actual = {line.split()[-1] for line in Path("black.out.txt").read_text().splitlines()}
          print("{expected - actual = }")
          print("{actual - expected = }")
